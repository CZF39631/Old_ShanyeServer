# 登录系统开发文档

## 1. 项目概述

当前项目是一个基于Flask的Web应用，主要包含导航页、链接库、商标库和产品库四个主要功能模块。目前项目没有用户认证系统，需要添加一个登录系统，使用JWT进行认证，未登录用户将被重定向到登录页面。

## 2. 需求分析

### 2.1 功能需求
- 添加登录页面
- 实现基于JWT的用户认证
- 未登录用户访问任何页面都将被重定向到登录页面
- 接口不需要绑定登录验证，仅页面访问需要验证
- 不提供前台注册功能，用户由管理员通过后台脚本添加

### 2.2 技术要求
- 使用Flask-JWT-Extended库实现JWT认证
- 最小化改动现有代码
- 保持项目原有的结构和风格

## 3. 系统设计

### 3.1 数据库设计

在现有的数据库中添加用户表（users）:

```sql
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT NOT NULL UNIQUE,
    password_hash TEXT NOT NULL,
    email TEXT UNIQUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    is_admin BOOLEAN DEFAULT 0
);
```

### 3.2 文件结构变更

需要新增以下文件：

```
APP/
  ├── 路由/
  │    ├── 用户.py       # 用户认证相关路由
  ├── 工具/
  │    ├── 认证.py       # JWT认证和用户验证工具
  ├── 数据库/
  │    ├── 用户管理.py   # 用户数据操作
  ├── 脚本/
  │    ├── 添加用户.py   # 管理员添加用户的脚本
templates/
  ├── 登录.html          # 登录页面
static/
  ├── css/
  │    ├── 登录.css      # 登录页面样式
```

### 3.3 认证流程

1. 用户访问任何页面时，检查是否已登录（通过JWT Cookie）
2. 若未登录，重定向到登录页面
3. 用户提交登录表单后，验证用户名和密码
4. 验证成功后，生成JWT令牌并设置为Cookie
5. 重定向用户到原始请求页面

## 4. 详细实现方案

### 4.1 依赖添加

在`requirements.txt`中添加：
```
flask-jwt-extended==4.5.3
werkzeug==2.3.7
```

### 4.2 认证工具实现（APP/工具/认证.py）

```python
from functools import wraps
from flask import request, redirect, url_for, current_app
from flask_jwt_extended import verify_jwt_in_request, get_jwt_identity, create_access_token, JWTManager

# 初始化JWT管理器
jwt = JWTManager()

def 配置JWT(app):
    """配置JWT管理器"""
    app.config['JWT_SECRET_KEY'] = 'your-secret-key'  # 在生产环境中应使用安全的密钥
    app.config['JWT_TOKEN_LOCATION'] = ['cookies']
    app.config['JWT_COOKIE_SECURE'] = False  # 在生产环境中应设为True
    app.config['JWT_COOKIE_CSRF_PROTECT'] = True
    app.config['JWT_ACCESS_TOKEN_EXPIRES'] = 86400  # 24小时
    jwt.init_app(app)

def 需要登录(f):
    """检查用户是否已登录的装饰器"""
    @wraps(f)
    def 装饰函数(*args, **kwargs):
        try:
            verify_jwt_in_request()
            return f(*args, **kwargs)
        except:
            return redirect(url_for('用户.登录页面', next=request.path))
    return 装饰函数

def 创建用户令牌(用户名):
    """为用户创建JWT令牌"""
    identity = {"username": 用户名}
    access_token = create_access_token(identity=identity)
    return access_token
```

### 4.3 用户数据管理（APP/数据库/用户管理.py）

```python
import sqlite3
import logging
from werkzeug.security import generate_password_hash, check_password_hash
from config import 数据库

def 获取数据库连接():
    """获取数据库连接"""
    return sqlite3.connect(数据库)

def 初始化用户表():
    """初始化用户数据表"""
    conn = 获取数据库连接()
    cursor = conn.cursor()
    try:
        cursor.execute('''
        CREATE TABLE IF NOT EXISTS users (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            username TEXT NOT NULL UNIQUE,
            password_hash TEXT NOT NULL,
            email TEXT UNIQUE,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            is_admin BOOLEAN DEFAULT 0
        )
        ''')
        conn.commit()
        logging.info("用户表初始化成功")
    except Exception as e:
        logging.error(f"用户表初始化失败: {e}")
    finally:
        conn.close()

def 创建用户(用户名, 密码, 邮箱=None, 是否管理员=False):
    """创建新用户"""
    conn = 获取数据库连接()
    cursor = conn.cursor()
    try:
        密码哈希 = generate_password_hash(密码)
        cursor.execute(
            "INSERT INTO users (username, password_hash, email, is_admin) VALUES (?, ?, ?, ?)",
            (用户名, 密码哈希, 邮箱, 是否管理员)
        )
        conn.commit()
        return True
    except sqlite3.IntegrityError:
        logging.error(f"用户创建失败: 用户名或邮箱已存在")
        return False
    except Exception as e:
        logging.error(f"用户创建失败: {e}")
        return False
    finally:
        conn.close()

def 验证用户(用户名, 密码):
    """验证用户凭据"""
    conn = 获取数据库连接()
    cursor = conn.cursor()
    try:
        cursor.execute("SELECT password_hash FROM users WHERE username = ?", (用户名,))
        结果 = cursor.fetchone()
        if 结果 and check_password_hash(结果[0], 密码):
            return True
        return False
    except Exception as e:
        logging.error(f"用户验证失败: {e}")
        return False
    finally:
        conn.close()
```

### 4.4 用户路由实现（APP/路由/用户.py）

```python
from flask import Blueprint, render_template, request, redirect, url_for, make_response, flash
from flask_jwt_extended import set_access_cookies, unset_jwt_cookies
from APP.数据库.用户管理 import 验证用户
from APP.工具.认证 import 创建用户令牌

# 创建用户蓝图
用户蓝图 = Blueprint('用户', __name__)

@用户蓝图.route('/登录', methods=['GET', 'POST'])
def 登录页面():
    """登录页面路由"""
    if request.method == 'POST':
        用户名 = request.form.get('username')
        密码 = request.form.get('password')
        下一页 = request.form.get('next') or url_for('导航页.导航页')
        
        if 验证用户(用户名, 密码):
            # 创建JWT令牌
            访问令牌 = 创建用户令牌(用户名)
            
            # 创建响应
            响应 = make_response(redirect(下一页))
            
            # 设置JWT Cookie
            set_access_cookies(响应, 访问令牌)
            
            return 响应
        else:
            flash('用户名或密码错误，请重试')
    
    # 获取下一页参数
    下一页 = request.args.get('next', '')
    
    return render_template('登录.html', next=下一页)

@用户蓝图.route('/登出')
def 登出():
    """登出路由"""
    响应 = make_response(redirect(url_for('用户.登录页面')))
    unset_jwt_cookies(响应)
    return 响应
```

### 4.5 管理员添加用户脚本（APP/脚本/添加用户.py）

```python
import sys
import os
import logging

# 添加项目根目录到Python路径
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '../..')))

from APP.数据库.用户管理 import 创建用户, 初始化用户表
from APP.日志.日志 import 配置日志

def 添加用户脚本():
    """管理员用于添加用户的脚本"""
    # 配置日志
    配置日志()
    
    # 初始化用户表
    初始化用户表()
    
    print("===== 用户添加工具 =====")
    
    # 获取用户输入
    用户名 = input("请输入用户名: ")
    密码 = input("请输入密码: ")
    邮箱 = input("请输入邮箱(可选): ") or None
    是否管理员 = input("是否为管理员(y/n): ").lower() == 'y'
    
    # 创建用户
    成功 = 创建用户(用户名, 密码, 邮箱, 是否管理员)
    
    if 成功:
        print(f"用户 {用户名} 创建成功!")
    else:
        print(f"用户 {用户名} 创建失败，可能用户名或邮箱已存在")

if __name__ == "__main__":
    添加用户脚本()
```

### 4.6 修改启动文件（启动.py）

需要对启动文件进行以下修改：

1. 导入新增的用户蓝图和JWT配置工具
2. 注册用户蓝图
3. 配置JWT
4. 初始化用户表

```python
import logging
from flask import Flask
from APP.路由.导航页 import 导航页蓝图
from APP.路由.链接库 import 链接库蓝图
from APP.路由.商标库 import 商标库蓝图
from APP.路由.产品库 import 产品库蓝图
from APP.路由.用户 import 用户蓝图  # 导入用户蓝图
from APP.日志.日志 import 配置日志
from APP.工具.链接库定时清除 import 启动定时任务
from APP.工具.认证 import 配置JWT  # 导入JWT配置工具
from APP.数据库.用户管理 import 初始化用户表  # 导入用户表初始化

def create_app():
    # 创建 Flask 应用
    app = Flask(__name__)

    # 注册蓝图
    app.register_blueprint(导航页蓝图)
    app.register_blueprint(链接库蓝图)
    app.register_blueprint(商标库蓝图)
    app.register_blueprint(产品库蓝图)
    app.register_blueprint(用户蓝图)  # 注册用户蓝图

    # 配置密钥
    app.config['SECRET_KEY'] = 'your-secret-key'  # 在生产环境中应使用安全的密钥
    
    # 配置JWT
    配置JWT(app)
    
    # 启动定时任务
    启动定时任务()
    
    # 初始化用户表
    初始化用户表()

    return app
```

### 4.7 修改导航页路由（APP/路由/导航页.py）

为所有页面路由添加登录检查装饰器：

```python
from flask import Blueprint, render_template
from APP.工具.认证 import 需要登录  # 导入登录检查装饰器

# 创建导航页蓝图
导航页蓝图 = Blueprint('导航页', __name__)

@导航页蓝图.route('/')
@需要登录  # 添加登录检查
def 导航页():
    """
    主页路由
    :return: 渲染 index.html 模板
    """
    return render_template('index.html')

# 添加链接库的路由
@导航页蓝图.route('/链接库')
@需要登录  # 添加登录检查
def 链接库():
    """
    链接库页面路由
    :return: 渲染 链接库.html 模板
    """
    return render_template('链接库.html')

@导航页蓝图.route('/商标库')
@需要登录  # 添加登录检查
def 商标库():
    """
    商标库页面路由
    :return: 渲染 商标查询.html 模板
    """
    return render_template('商标查询.html')

@导航页蓝图.route('/产品库')
@需要登录  # 添加登录检查
def 产品库():
    """
    商标库页面路由
    :return: 渲染 商标查询.html 模板
    """
    return render_template('产品库.html')
```

### 4.8 登录页面模板（templates/登录.html）

```html
{% extends "base.html" %}

{% block title %}用户登录{% endblock %}

{% block content %}
<div class="login-container">
    <h2>用户登录</h2>
    
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="alert alert-warning">
            {% for message in messages %}
              {{ message }}
            {% endfor %}
        </div>
      {% endif %}
    {% endwith %}
    
    <form method="post" action="{{ url_for('用户.登录页面') }}">
        <input type="hidden" name="next" value="{{ next }}">
        
        <div class="form-group">
            <label for="username">用户名</label>
            <input type="text" id="username" name="username" required>
        </div>
        
        <div class="form-group">
            <label for="password">密码</label>
            <input type="password" id="password" name="password" required>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn-login">登录</button>
        </div>
    </form>
</div>
{% endblock %}
```

### 4.9 登录样式（static/css/登录.css）

```css
/* 登录页面样式 */
.login-container {
    max-width: 400px;
    margin: 50px auto;
    padding: 20px;
    border-radius: 5px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    background-color: #fff;
}

.login-container h2 {
    text-align: center;
    margin-bottom: 20px;
    color: #333;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
    color: #555;
}

.form-group input {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

.form-actions {
    display: flex;
    justify-content: center;
    margin-top: 20px;
}

.btn-login {
    padding: 10px 30px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    background-color: #4CAF50;
    color: white;
}

.alert {
    padding: 10px;
    margin-bottom: 15px;
    border-radius: 4px;
    color: #856404;
    background-color: #fff3cd;
    border: 1px solid #ffeeba;
}
```

## 5. 安全注意事项

1. 在生产环境中，应使用安全的随机密钥替代文档中的"your-secret-key"
2. 启用HTTPS，并将JWT_COOKIE_SECURE设置为True
3. 定期轮换JWT密钥
4. 实现密码策略（长度、复杂度等）
5. 考虑添加用户锁定机制防止暴力破解
6. 考虑添加二次认证机制提高安全性
7. 脚本添加用户时应验证密码复杂度

## 6. 实施计划

1. 添加所需依赖到requirements.txt
2. 创建用户数据表
3. 实现认证工具和用户管理功能
4. 创建添加用户脚本并添加初始管理员账户
5. 创建登录页面
6. 修改现有路由添加登录检查
7. 测试登录和保护路由功能
8. 确保会话管理和Cookie设置正确

## 7. 测试计划

1. 单元测试：
   - 用户创建和验证功能
   - JWT令牌生成和验证
   - 路由保护装饰器

2. 集成测试：
   - 登录流程
   - 用户添加脚本功能
   - 保护路由访问控制
   - 令牌过期和刷新

3. 用户界面测试：
   - 登录表单验证
   - 错误消息显示
   - 响应式设计

## 8. 未来扩展

1. 添加用户角色和权限系统
2. 实现密码重置功能
3. 添加用户管理页面（仅限管理员）
4. 实现API接口的认证保护
5. 添加用户会话管理功能
6. 实现登录日志记录
