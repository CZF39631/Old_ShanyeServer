# 登录系统开发文档

## 1. 项目概述

当前项目是一个基于Flask的Web应用，主要包含导航页、链接库、商标库和产品库四个主要功能模块。目前项目没有用户认证系统，需要添加一个登录系统，使用JWT进行认证，未登录用户将被重定向到登录页面。

## 2. 需求分析

### 2.1 功能需求
- 添加登录页面
- 实现基于JWT的用户认证
- 未登录用户访问任何页面都将被重定向到登录页面
- 接口不需要绑定登录验证，仅页面访问需要验证
- 不提供前台注册功能，用户由管理员通过后台脚本添加

### 2.2 技术要求
- 使用Flask-JWT-Extended库实现JWT认证
- 最小化改动现有代码
- 保持项目原有的结构和风格
- 前后端密码采用MD5加密，确保后端无法接触明文密码

## 3. 系统设计

### 3.1 数据库设计

在现有的数据库中添加用户表（users）:

```sql
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT NOT NULL UNIQUE,
    password_hash TEXT NOT NULL,
    email TEXT UNIQUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    is_admin BOOLEAN DEFAULT 0
);
```

### 3.2 文件结构变更

需要新增以下文件：

```
APP/
  ├── 路由/
  │    ├── 用户.py       # 用户认证相关路由
  ├── 工具/
  │    ├── 认证.py       # JWT认证和用户验证工具
  ├── 数据库/
  │    ├── 用户管理.py   # 用户数据操作
  ├── 脚本/
  │    ├── 添加用户.py   # 管理员添加用户的脚本
templates/
  ├── 登录.html          # 登录页面
static/
  ├── css/
  │    ├── 登录.css      # 登录页面样式
```

### 3.3 认证流程

1. 用户访问任何页面时，检查是否已登录（通过JWT Cookie）
2. 若未登录，重定向到登录页面
3. 用户在前端输入用户名和密码，前端使用MD5加密密码
4. 前端发送用户名和加密后的密码到后端
5. 后端验证用户名和MD5加密密码
6. 验证成功后，生成JWT令牌并设置为Cookie
7. 重定向用户到原始请求页面

## 4. 详细实现方案

### 4.1 依赖添加

在`requirements.txt`中需要添加以下依赖：
- flask-jwt-extended：用于JWT认证
- werkzeug：用于Web应用
- hashlib：用于MD5加密（Python标准库）

### 4.2 认证工具实现（APP/工具/认证.py）

实现以下功能：
- 初始化JWT管理器
- 配置JWT（密钥、过期时间、Cookie设置等）
- 创建需要登录的装饰器，用于保护路由
- 实现创建用户令牌的函数

### 4.3 用户数据管理（APP/数据库/用户管理.py）

实现以下功能：
- 获取数据库连接
- 初始化用户表
- 创建用户（接收已经MD5加密的密码）
- 验证用户（比较数据库中存储的MD5哈希与前端传来的MD5哈希）

### 4.4 用户路由实现（APP/路由/用户.py）

实现以下功能：
- 登录页面路由（GET和POST方法）
- 处理登录表单提交（验证MD5加密的密码）
- 创建JWT令牌并设置Cookie
- 登出路由（清除JWT Cookie）

### 4.5 管理员添加用户脚本（APP/脚本/添加用户.py）

实现以下功能：
- 命令行界面供管理员添加用户
- 获取用户输入（用户名、密码、邮箱、管理员权限）
- 对输入的密码进行MD5加密
- 调用用户管理模块创建用户

### 4.6 修改启动文件（启动.py）

需要对启动文件进行以下修改：
- 导入新增的用户蓝图和JWT配置工具
- 注册用户蓝图
- 配置JWT
- 初始化用户表

### 4.7 修改导航页路由（APP/路由/导航页.py）

为所有页面路由添加登录检查装饰器，确保只有已登录用户可以访问。

### 4.8 登录页面模板（templates/登录.html）

登录页面应包含以下元素：
- 用户名输入框
- 密码输入框
- 隐藏的MD5密码字段
- 登录按钮
- 表单提交前使用JavaScript进行密码MD5加密
- 引入CryptoJS库用于MD5加密

### 4.9 登录样式（static/css/登录.css）

设计登录页面的样式，包括容器、表单元素、按钮和提示信息的样式。

## 5. 安全注意事项

1. 在生产环境中，应使用安全的随机密钥替代文档中的"your-secret-key"
2. 启用HTTPS，并将JWT_COOKIE_SECURE设置为True
3. 定期轮换JWT密钥
4. 实现密码策略（长度、复杂度等）
5. 考虑添加用户锁定机制防止暴力破解
6. 考虑添加二次认证机制提高安全性
7. 脚本添加用户时应验证密码复杂度
8. 虽然使用了MD5加密密码，但MD5不是最安全的哈希算法，未来可考虑更强的哈希算法如SHA-256
9. 考虑在MD5之前添加盐值，进一步提高安全性

## 6. 实施计划

1. 添加所需依赖到requirements.txt
2. 创建用户数据表
3. 实现认证工具和用户管理功能
4. 创建添加用户脚本并添加初始管理员账户
5. 创建登录页面
6. 修改现有路由添加登录检查
7. 测试登录和保护路由功能
8. 确保会话管理和Cookie设置正确

## 7. 测试计划

1. 单元测试：
   - 用户创建和验证功能
   - JWT令牌生成和验证
   - 路由保护装饰器

2. 集成测试：
   - 登录流程
   - 用户添加脚本功能
   - 保护路由访问控制
   - 令牌过期和刷新

3. 用户界面测试：
   - 登录表单验证
   - 错误消息显示
   - 响应式设计

## 8. 未来扩展

1. 添加用户角色和权限系统
2. 实现密码重置功能
3. 添加用户管理页面（仅限管理员）
4. 实现API接口的认证保护
5. 添加用户会话管理功能
6. 实现登录日志记录
